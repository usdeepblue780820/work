<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ’ç­ç®¡ç†ç³»çµ±</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9; /* Slate-100 */
            -webkit-tap-highlight-color: transparent;
        }
        .shift-cell {
            transition: all 0.2s;
        }
        .shift-cell:active {
            transform: scale(0.90);
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .custom-scroll::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #94a3b8; 
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }
        .sticky-col-header { z-index: 30 !important; }
        .sticky-col-cell { z-index: 20 !important; }
        
        /* Modal Animation */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-overlay { animation: fadeIn 0.2s ease-out; }
        .modal-content { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ================= CONFIGURATION =================
        // è«‹ç¢ºèªæ­¤è™•å·²æ›¿æ›ç‚ºæ‚¨éƒ¨ç½²å¾Œçš„ GAS ç¶²å€
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyEwMHBO8jVA0IoS_HdzNFHsyzCz-lxVmW3s9jPcK8gaZDVq1JT5ieeMnQT3V-oNy_U/exec"; 
        
        const STORE_FILTERS = [
            { id: 'all', label: 'å…¨éƒ¨åˆ†åº—' },
            { id: 'æ¹–å£', label: 'æ¹–å£ä¸­å±±' },
            { id: 'æˆåŠŸ', label: 'ç«¹åŒ—æˆåŠŸ' }
        ];
        // =================================================

        const { useState, useEffect, useMemo, useRef } = React;

        // æ¨¡æ“¬æ•¸æ“š
        const MOCK_MONTHS = ["2025-07", "2025-06"];
        const MOCK_DB = {
            "2025-06": {
                dates: Array.from({length: 30}, (_, i) => `2025/06/${String(i+1).padStart(2, '0')}`),
                schedule: [
                    { name: "é™³æ€è˜‹", title: "åº—é•·", store: "æ¹–å£", shifts: { "2025/06/01": {type: "1200", note: ""}, "2025/06/02": {type: "1230", note: ""} } },
                    { name: "ç¾å®¹å¸«A", title: "ç¾å®¹å¸«", store: "æ¹–å£", shifts: { "2025/06/01": {type: "1230", note: ""}, "2025/06/02": {type: "1300", note: ""} } },
                ]
            }
        };

        // å½ˆè·³è¦–çª—çµ„ä»¶ (ç•«ä¼‘åŸå› )
        const ReasonModal = ({ isOpen, onClose, onConfirm, date, isMandatory }) => {
            const [reason, setReason] = useState("");
            const [error, setError] = useState("");
            const inputRef = useRef(null);

            useEffect(() => {
                if (isOpen) {
                    setReason("");
                    setError("");
                    setTimeout(() => inputRef.current?.focus(), 100);
                }
            }, [isOpen]);

            if (!isOpen) return null;

            const handleSubmit = () => {
                if (isMandatory && !reason.trim()) {
                    setError("æœ¬æœˆä¼‘å‡å·²é”ä¸Šé™ï¼Œè«‹å‹™å¿…å¡«å¯«åŸå› ");
                    return;
                }
                onConfirm(reason);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center px-4 modal-overlay">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden modal-content relative z-10">
                        <div className="bg-slate-800 text-white px-4 py-3 flex justify-between items-center">
                            <h3 className="font-bold text-lg"><i className="fa-solid fa-pen-to-square mr-2"></i>ç•«ä¼‘ç¢ºèª</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><i className="fa-solid fa-xmark text-xl"></i></button>
                        </div>
                        <div className="p-5">
                            <div className="mb-4">
                                <p className="text-slate-600 mb-1 font-medium">æ—¥æœŸï¼š<span className="text-slate-900 font-bold">{date}</span></p>
                                {isMandatory ? (
                                    <div className="bg-red-50 text-red-600 text-xs px-2 py-1 rounded border border-red-100 flex items-center gap-1">
                                        <i className="fa-solid fa-circle-exclamation"></i>
                                        <span>æœ¬æœˆå·²ç•«ä¼‘ 4 å¤©ä»¥ä¸Šï¼ŒåŸå› ç‚ºå¿…å¡«ã€‚</span>
                                    </div>
                                ) : (
                                    <div className="text-xs text-slate-400">æœ¬æœˆç•«ä¼‘å°‘æ–¼ 4 å¤©ï¼ŒåŸå› å¯é¸å¡«ã€‚</div>
                                )}
                            </div>
                            
                            <label className="block text-sm font-medium text-slate-700 mb-1">
                                ä¼‘å‡åŸå›  {isMandatory && <span className="text-red-500">*</span>}
                            </label>
                            <input 
                                ref={inputRef}
                                type="text" 
                                value={reason}
                                onChange={(e) => { setReason(e.target.value); setError(""); }}
                                placeholder={isMandatory ? "è«‹è¼¸å…¥åŸå›  (å¿…å¡«)" : "ä¾‹å¦‚: è™•ç†ç§äº‹ (é¸å¡«)"}
                                className={`w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 transition-all ${error ? 'border-red-500 focus:ring-red-200' : 'border-slate-300 focus:border-blue-500 focus:ring-blue-100'}`}
                                onKeyDown={(e) => e.key === 'Enter' && handleSubmit()}
                            />
                            {error && <p className="text-red-500 text-xs mt-1">{error}</p>}
                            
                            <div className="flex gap-3 mt-6">
                                <button onClick={onClose} className="flex-1 px-4 py-2 border border-slate-300 text-slate-600 rounded-lg text-sm hover:bg-slate-50 transition-colors">å–æ¶ˆ</button>
                                <button onClick={handleSubmit} className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold shadow-md hover:bg-blue-700 transition-colors">ç¢ºå®šç•«ä¼‘</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ShiftBadge = ({ data, onClick, isEditable, isSmall }) => {
            const type = data ? String(data.type) : ""; 
            const note = data ? data.note : "";
            const hasNote = note && note.trim() !== "";

            let colorClass = "bg-slate-50 text-slate-300";
            let content = type; 

            switch(type) {
                case "1000": // ç«ç‘°ç´…
                    colorClass = "bg-rose-100 text-rose-700 border border-rose-200";
                    break;
                case "1030": // æ©˜è‰²
                    colorClass = "bg-orange-100 text-orange-700 border border-orange-200";
                    break;
                case "1200": // Sky-200
                    colorClass = "bg-sky-200 text-sky-800 border border-sky-300";
                    break;
                case "1230": // Blue-300
                    colorClass = "bg-blue-300 text-blue-900 border border-blue-400";
                    break;
                case "1300": // ç´«è‰²
                    colorClass = "bg-purple-100 text-purple-700 border border-purple-200";
                    break;
                case "ç‰¹": // ç°è‰²
                    colorClass = "bg-gray-200 text-gray-700 border border-gray-300 font-bold";
                    break;
                case "æœƒ": // æ·±ç¶ 
                    colorClass = "bg-green-600 text-white border border-green-700 font-bold shadow-sm";
                    break;
                case "æˆåŠŸ": // æ·ºç¶ 
                    colorClass = "bg-emerald-100 text-emerald-700 border border-emerald-200";
                    break;
                case "ä¼‘": 
                    colorClass = "bg-yellow-100 text-red-500 border border-yellow-200 font-bold"; 
                    content = <i className="fa-solid fa-bed"></i>; 
                    break;
                default:
                    if(isEditable && !type) {
                        colorClass = "bg-white border border-dashed border-slate-300 active:bg-slate-100 cursor-pointer hover:border-blue-400";
                        content = <i className="fa-solid fa-plus text-slate-200 scale-75"></i>;
                    }
                    break;
            }

            const sizeClass = isSmall ? "w-8 h-8 text-xs" : "w-10 h-10 md:w-11 md:h-11 text-xs md:text-sm";
            const textSizeClass = (type.length >= 4 && !isSmall) ? "text-[10px] md:text-xs" : ""; 

            const handleClick = () => {
                if (isEditable) onClick();
                else if (hasNote) alert(`ğŸ“… ä¼‘å‡åŸå› ï¼š\n${note}`);
            };

            return (
                <div 
                    onClick={handleClick}
                    className={`
                        ${colorClass} ${sizeClass} ${textSizeClass}
                        ${isEditable || hasNote ? 'cursor-pointer' : ''}
                        rounded-lg flex items-center justify-center transition-all duration-200 mx-auto
                        shadow-sm relative font-sans tracking-tight
                    `}
                    title={note} 
                >
                    {content}
                    {hasNote && (
                        <span className="absolute -top-1 -right-1 flex h-3 w-3">
                          <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                          <span className="relative inline-flex rounded-full h-3 w-3 bg-red-500 border-2 border-white"></span>
                        </span>
                    )}
                </div>
            );
        };

        const App = () => {
            const [initLoading, setInitLoading] = useState(true);
            const [scheduleLoading, setScheduleLoading] = useState(false);
            const [months, setMonths] = useState([]);
            const [currentMonth, setCurrentMonth] = useState("");
            const [scheduleData, setScheduleData] = useState({ dates: [], schedule: [] });
            
            const [currentUser, setCurrentUser] = useState("");
            const [viewMode, setViewMode] = useState("view"); 
            const [statusMsg, setStatusMsg] = useState("");
            
            // ç§»é™¤æœå°‹å§“åçš„ state
            const [filterStore, setFilterStore] = useState("all");
            const [showFilters, setShowFilters] = useState(false);

            const [modalConfig, setModalConfig] = useState({ isOpen: false, name: "", date: "", isMandatory: false });

            const tableContainerRef = useRef(null);

            useEffect(() => { fetchMonths(); }, []);
            useEffect(() => { if (currentMonth) fetchSchedule(currentMonth); }, [currentMonth]);

            const fetchMonths = async () => {
                setInitLoading(true);
                if (!APPS_SCRIPT_URL) {
                    setTimeout(() => { setMonths(MOCK_MONTHS); setCurrentMonth(MOCK_MONTHS[0]); setInitLoading(false); }, 600);
                    return;
                }
                try {
                    const response = await fetch(`${APPS_SCRIPT_URL}?action=getMonths&_t=${new Date().getTime()}`);
                    const data = await response.json();
                    if (data.status === "success") {
                        setMonths(data.months);
                        if (data.months.length > 0) setCurrentMonth(data.months[0]);
                    } else {
                        setStatusMsg("ç„¡æ³•è®€å–æœˆä»½åˆ—è¡¨");
                    }
                } catch (e) {
                    setStatusMsg("é€£ç·šéŒ¯èª¤ (å–å¾—æœˆä»½å¤±æ•—)");
                } finally {
                    setInitLoading(false);
                }
            };

            const fetchSchedule = async (month) => {
                setScheduleLoading(true);
                setScheduleData({ dates: [], schedule: [] }); 

                if (!APPS_SCRIPT_URL) {
                    setTimeout(() => {
                        const data = MOCK_DB[month] || { dates: [], schedule: [] };
                        setScheduleData(data);
                        if(data.schedule.length > 0 && !currentUser) setCurrentUser(data.schedule[0].name);
                        setScheduleLoading(false);
                    }, 500);
                    return;
                }
                try {
                    const response = await fetch(`${APPS_SCRIPT_URL}?action=getSchedule&sheetName=${encodeURIComponent(month)}&_t=${new Date().getTime()}`);
                    const data = await response.json();
                    if (data.status === "success") {
                        setScheduleData({ dates: data.dates, schedule: data.schedule });
                        if(data.schedule.length > 0 && !currentUser) setCurrentUser(data.schedule[0].name);
                    } else {
                        setStatusMsg(`è®€å–å¤±æ•—: ${data.message}`);
                    }
                } catch (e) {
                    setStatusMsg("é€£ç·šéŒ¯èª¤ (å–å¾—ç­è¡¨å¤±æ•—)");
                } finally {
                    setScheduleLoading(false);
                }
            };

            const initiateShiftUpdate = (name, date, currentData) => {
                if (viewMode === 'view') return;
                if (name !== currentUser) {
                    alert("æ‚¨åªèƒ½ç•«è‡ªå·±çš„å‡å–”ï¼");
                    return;
                }
                const currentType = currentData ? String(currentData.type) : "";
                if (currentType === "ä¼‘") {
                    executeShiftUpdate(name, date, "");
                    return;
                }
                const userRecord = scheduleData.schedule.find(u => u.name === name);
                const currentRestCount = userRecord ? Object.values(userRecord.shifts).filter(v => v && v.type === "ä¼‘").length : 0;
                const isMandatory = currentRestCount >= 4;
                setModalConfig({ isOpen: true, name, date, isMandatory });
            };

            const executeShiftUpdate = async (name, date, newType, reason = "") => {
                setScheduleData(prev => ({
                    ...prev,
                    schedule: prev.schedule.map(u => u.name === name ? {
                        ...u, 
                        shifts: {
                            ...u.shifts, 
                            [date]: { type: newType, note: reason }
                        }
                    } : u)
                }));
                setModalConfig({ isOpen: false, name: "", date: "", isMandatory: false });

                if (!APPS_SCRIPT_URL) return;

                try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: "POST",
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify({ 
                            action: "updateShift", 
                            sheetName: currentMonth, 
                            name, 
                            date, 
                            type: newType,
                            reason: reason 
                        })
                    });
                    const result = await response.json();
                    if (result.status !== "success") {
                        alert("æ›´æ–°å¤±æ•—ï¼š" + result.message);
                        fetchSchedule(currentMonth);
                    }
                } catch (e) {
                    alert("é€£ç·šå¤±æ•—ï¼Œç„¡æ³•å„²å­˜");
                }
            };

            // ç¯©é¸é‚è¼¯ï¼šç§»é™¤æœå°‹å§“åï¼Œåªä¿ç•™åˆ†åº—èˆ‡è·ç¨±åˆ¤æ–·
            const filteredSchedule = useMemo(() => {
                return scheduleData.schedule.filter(user => {
                    if (user.name === 'å§“å') return false;
                    
                    const storeValue = user.store || user.name;
                    const titleValue = user.title || ""; 
                    
                    const isManager = titleValue.includes("åº—é•·");
                    const storeMatch = filterStore === 'all' || storeValue.includes(filterStore);
                    
                    return storeMatch || isManager;
                });
            }, [scheduleData.schedule, filterStore]);

            const userList = useMemo(() => scheduleData.schedule.filter(u => u.name !== 'å§“å').map(u => u.name), [scheduleData]);

            // ä¿®æ”¹ç‚ºã€Œè·³è‡³æœ¬æœˆä»½ã€é‚è¼¯
            const goToCurrentMonth = () => {
                const now = new Date();
                // æ ¼å¼åŒ–ç‚º YYYY-MM
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const target = `${year}-${month}`;
                
                // æª¢æŸ¥æœˆä»½åˆ—è¡¨æ˜¯å¦æœ‰æœ¬æœˆä»½ (æ¯”å°å­—ä¸²)
                const exists = months.includes(target);
                
                if (exists) {
                    setCurrentMonth(target);
                } else {
                    alert(`ç³»çµ±ä¸­æ‰¾ä¸åˆ°æœ¬æœˆä»½ (${target}) çš„ç­è¡¨è³‡æ–™`);
                }
            };

            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                const day = date.getDate();
                const month = date.getMonth() + 1;
                const weekDay = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][date.getDay()];
                const isWeekend = weekDay === 'å…­' || weekDay === 'æ—¥';
                return (
                    <div className="flex flex-col items-center justify-center h-full">
                        <span className="text-[10px] text-slate-400 leading-none mb-1">{month}æœˆ</span>
                        <span className={`text-sm font-bold leading-none ${isWeekend ? 'text-red-500' : 'text-slate-700'}`}>{day}</span>
                        <span className={`text-[10px] mt-1 leading-none ${isWeekend ? 'text-red-400' : 'text-slate-400'}`}>{weekDay}</span>
                    </div>
                );
            };

            return (
                <div className="flex flex-col h-screen bg-slate-100 text-slate-800 font-sans">
                    
                    {/* Modal */}
                    <ReasonModal 
                        isOpen={modalConfig.isOpen}
                        onClose={() => setModalConfig({...modalConfig, isOpen: false})}
                        onConfirm={(reason) => executeShiftUpdate(modalConfig.name, modalConfig.date, "ä¼‘", reason)}
                        date={modalConfig.date}
                        isMandatory={modalConfig.isMandatory}
                    />

                    {/* Header */}
                    <header className="bg-slate-800 text-white shadow-lg z-40 shrink-0">
                        <div className="flex items-center justify-between px-4 py-3">
                            <div className="flex items-center gap-2">
                                <div className="bg-blue-600 w-8 h-8 rounded-lg flex items-center justify-center shadow-inner">
                                    <i className="fa-solid fa-calendar-check text-white text-sm"></i>
                                </div>
                                <span className="font-bold text-lg tracking-wide text-slate-100">æ’ç­ç³»çµ±</span>
                            </div>
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={() => setShowFilters(!showFilters)}
                                    className={`md:hidden p-2 rounded-full transition-colors ${showFilters ? 'bg-slate-700 text-blue-400' : 'hover:bg-slate-700 text-slate-300'}`}
                                >
                                    <i className="fa-solid fa-filter"></i>
                                </button>
                                <div className="hidden md:block text-xs bg-slate-700 text-slate-200 px-3 py-1 rounded-full border border-slate-600">
                                    {currentMonth || "Loading..."}
                                </div>
                            </div>
                        </div>
                        
                        {/* Mobile Filters (Removed Search Input) */}
                        <div className={`md:hidden bg-slate-800 overflow-hidden transition-all duration-300 ease-in-out border-b border-slate-700 ${showFilters ? 'max-h-64' : 'max-h-0'}`}>
                            <div className="p-4 space-y-3">
                                <div className="flex bg-slate-700 rounded-lg p-1 border border-slate-600">
                                    {STORE_FILTERS.map(filter => (
                                        <button
                                            key={filter.id}
                                            onClick={() => setFilterStore(filter.id)}
                                            className={`flex-1 py-2 text-xs font-medium rounded-md transition-all ${filterStore === filter.id ? 'bg-blue-600 text-white shadow' : 'text-slate-400'}`}
                                        >
                                            {filter.label.replace('å…¨éƒ¨', '') || 'å…¨éƒ¨'}
                                        </button>
                                    ))}
                                </div>
                                <div className="flex gap-2">
                                    <select 
                                        value={currentMonth} 
                                        onChange={(e) => setCurrentMonth(e.target.value)}
                                        className="flex-1 bg-slate-700 border border-slate-600 text-slate-200 rounded-lg py-2 px-3 text-sm"
                                    >
                                        {months.map(m => <option key={m} value={m}>{m}</option>)}
                                    </select>
                                    <button onClick={goToCurrentMonth} className="bg-slate-700 border border-slate-600 text-blue-400 px-4 py-2 rounded-lg text-sm font-medium">
                                        <i className="fa-solid fa-calendar-day"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="flex-1 overflow-hidden flex flex-col relative w-full max-w-7xl mx-auto shadow-xl bg-white md:my-4 md:rounded-xl">
                        
                        {/* Desktop Toolbar (Removed Search Input) */}
                        <div className="hidden md:flex items-center justify-between p-4 bg-white border-b border-slate-200 gap-4">
                            <div className="flex gap-3 items-center">
                                <div className="flex bg-slate-100 p-1 rounded-lg">
                                    {STORE_FILTERS.map(filter => (
                                        <button
                                            key={filter.id}
                                            onClick={() => setFilterStore(filter.id)}
                                            className={`px-3 py-1.5 text-sm rounded-md transition-all ${filterStore === filter.id ? 'bg-white shadow-sm text-blue-700 font-bold' : 'text-slate-500 hover:text-slate-700'}`}
                                        >
                                            {filter.label}
                                        </button>
                                    ))}
                                </div>
                                <button onClick={goToCurrentMonth} className="text-slate-500 hover:text-blue-600 text-sm px-2 transition-colors">
                                    <i className="fa-solid fa-calendar-day mr-1"></i>è·³è‡³æœ¬æœˆä»½
                                </button>
                            </div>

                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200">
                                    <label className="text-xs text-slate-500 font-bold">æˆ‘æ˜¯:</label>
                                    <select 
                                        value={currentUser} 
                                        onChange={(e) => setCurrentUser(e.target.value)}
                                        className="bg-transparent text-slate-700 text-sm outline-none font-medium border-none p-0 w-24"
                                    >
                                        <option value="">é¸æ“‡å“¡å·¥</option>
                                        {userList.map(u => <option key={u} value={u}>{u}</option>)}
                                    </select>
                                </div>
                                <div className="h-6 w-px bg-slate-200"></div>
                                <div className="flex bg-slate-100 p-1 rounded-lg">
                                    <button 
                                        onClick={() => setViewMode("view")}
                                        className={`px-3 py-1.5 text-sm rounded-md transition-all ${viewMode === 'view' ? 'bg-white shadow text-slate-800 font-bold' : 'text-slate-500'}`}
                                    >
                                        ç€è¦½
                                    </button>
                                    <button 
                                        onClick={() => setViewMode("edit")}
                                        className={`px-3 py-1.5 text-sm rounded-md transition-all ${viewMode === 'edit' ? 'bg-blue-600 shadow text-white font-bold' : 'text-slate-500'}`}
                                    >
                                        ç•«ä¼‘
                                    </button>
                                </div>
                                <select 
                                    value={currentMonth} 
                                    onChange={(e) => setCurrentMonth(e.target.value)}
                                    className="bg-white border border-slate-200 text-slate-700 py-1.5 px-3 rounded-lg text-sm font-bold shadow-sm outline-none hover:border-blue-400 transition-colors"
                                >
                                    {months.map(m => <option key={m} value={m}>{m}</option>)}
                                </select>
                            </div>
                        </div>

                        {/* Status Message */}
                        {statusMsg && (
                            <div className="bg-red-50 text-red-600 px-4 py-2 text-xs flex justify-between items-center border-b border-red-100 animate-pulse">
                                <span><i className="fa-solid fa-circle-exclamation mr-1"></i>{statusMsg}</span>
                                <button onClick={() => setStatusMsg("")}><i className="fa-solid fa-xmark"></i></button>
                            </div>
                        )}

                        {/* Mobile Actions Bar */}
                        <div className="md:hidden flex justify-between items-center px-4 py-3 bg-white border-b border-slate-200 shadow-sm shrink-0">
                            <div className="flex items-center gap-2 flex-1 bg-slate-50 px-3 py-2 rounded-lg border border-slate-100">
                                <i className="fa-solid fa-user text-slate-400 text-xs"></i>
                                <select 
                                    value={currentUser} 
                                    onChange={(e) => setCurrentUser(e.target.value)}
                                    className="w-full bg-transparent text-sm font-bold text-slate-700 outline-none border-none p-0"
                                >
                                    <option value="">è«‹é¸æ“‡æ‚¨çš„å§“å</option>
                                    {userList.map(u => <option key={u} value={u}>{u}</option>)}
                                </select>
                            </div>
                            <button 
                                onClick={() => setViewMode(viewMode === 'view' ? 'edit' : 'view')}
                                className={`ml-3 px-4 py-2 rounded-lg text-xs font-bold border transition-all shadow-sm ${viewMode === 'edit' ? 'bg-blue-600 border-blue-600 text-white' : 'bg-white border-slate-200 text-slate-600'}`}
                            >
                                {viewMode === 'edit' ? <><i className="fa-solid fa-pen mr-1"></i>ç•«ä¼‘ä¸­</> : <><i className="fa-solid fa-eye mr-1"></i>ç€è¦½ä¸­</>}
                            </button>
                        </div>

                        {/* Table Area */}
                        <div className="flex-1 overflow-hidden relative bg-white">
                            {initLoading || scheduleLoading ? (
                                <div className="absolute inset-0 flex flex-col items-center justify-center bg-white/80 z-40 backdrop-blur-[1px]">
                                    <div className="animate-spin rounded-full h-8 w-8 border-2 border-blue-600 border-t-transparent mb-3"></div>
                                    <span className="text-xs text-slate-500 font-medium">è³‡æ–™åŒæ­¥ä¸­...</span>
                                </div>
                            ) : null}

                            {scheduleData.schedule.length > 0 ? (
                                <div ref={tableContainerRef} className="h-full overflow-auto custom-scroll">
                                    <table className="border-collapse w-full min-w-max">
                                        <thead className="sticky top-0 z-30 bg-slate-50 shadow-sm">
                                            <tr>
                                                <th className="sticky left-0 z-40 bg-slate-50 p-0 border-b border-slate-200 border-r min-w-[100px] w-[100px] shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                                                    <div className="h-14 flex items-center justify-center text-xs text-slate-500 font-bold tracking-wider">
                                                        å“¡å·¥å§“å
                                                    </div>
                                                </th>
                                                {scheduleData.dates.map(date => (
                                                    <th key={date} className="bg-slate-50 p-1 min-w-[50px] w-[50px] border-b border-r border-slate-100 last:border-r-0 h-14 align-top">
                                                        {formatDate(date)}
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50">
                                            {filteredSchedule.length === 0 ? (
                                                <tr>
                                                    <td colSpan={scheduleData.dates.length + 1} className="text-center py-10 text-slate-400 text-sm">
                                                        <div className="flex flex-col items-center gap-2">
                                                            <i className="fa-solid fa-filter-circle-xmark text-2xl opacity-50"></i>
                                                            <span>æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„è³‡æ–™</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ) : (
                                                filteredSchedule.map((user) => {
                                                    const isMe = user.name === currentUser;
                                                    const rowBg = isMe ? "bg-blue-50/40" : "bg-white";
                                                    const nameColor = isMe ? "text-blue-700" : "text-slate-700";
                                                    
                                                    return (
                                                        <tr key={user.name} className={`${rowBg} hover:bg-slate-50 transition-colors`}>
                                                            <td className={`sticky left-0 z-20 ${rowBg} p-0 border-r border-slate-100 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]`}>
                                                                <div className="h-12 flex items-center px-4 relative">
                                                                    {isMe && <div className="w-1 h-full bg-blue-500 absolute left-0 top-0"></div>}
                                                                    <div className="flex items-center h-full w-full">
                                                                        <span className={`text-sm truncate w-full font-medium ${nameColor}`}>
                                                                            {user.name || "æœªå‘½å"}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            {scheduleData.dates.map(date => (
                                                                <td key={`${user.name}-${date}`} className="p-1 border-r border-slate-50 text-center h-12">
                                                                    <ShiftBadge 
                                                                        data={user.shifts[date]} 
                                                                        isEditable={viewMode === 'edit' && isMe}
                                                                        isSmall={true}
                                                                        onClick={() => initiateShiftUpdate(user.name, date, user.shifts[date])}
                                                                    />
                                                                </td>
                                                            ))}
                                                        </tr>
                                                    );
                                                })
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            ) : (
                                <div className="flex flex-col items-center justify-center h-full text-slate-400">
                                    <i className="fa-regular fa-calendar-xmark text-4xl mb-3 opacity-50"></i>
                                    <span className="text-sm font-medium">æœ¬æœˆå°šç„¡ç­è¡¨è³‡æ–™</span>
                                </div>
                            )}
                        </div>

                        {/* Legend Footer */}
                        <div className="bg-white border-t border-slate-200 p-3 shrink-0 overflow-x-auto no-scrollbar">
                            <div className="flex justify-start md:justify-center gap-4 min-w-max px-2">
                                <div className="flex items-center text-xs text-slate-600"><span className="w-3 h-3 rounded bg-rose-100 border border-rose-200 mr-1.5"></span>1000</div>
                                <div className="flex items-center text-xs text-slate-600"><span className="w-3 h-3 rounded bg-orange-100 border border-orange-200 mr-1.5"></span>1030</div>
                                <div className="flex items-center text-xs text-slate-600"><span className="w-3 h-3 rounded bg-sky-200 border border-sky-300 mr-1.5"></span>1200</div>
                                <div className="flex items-center text-xs text-slate-600"><span className="w-3 h-3 rounded bg-blue-300 border border-blue-400 mr-1.5"></span>1230</div>
                                <div className="flex items-center text-xs text-slate-600"><span className="w-3 h-3 rounded bg-purple-100 border border-purple-200 mr-1.5"></span>1300</div>
                                <div className="flex items-center text-xs text-slate-600"><span className="w-3 h-3 rounded bg-gray-200 border border-gray-300 mr-1.5"></span>ç‰¹</div>
                                <div className="flex items-center text-xs text-slate-600"><span className="w-3 h-3 rounded bg-green-600 border border-green-700 mr-1.5"></span>æœƒ</div>
                                <div className="flex items-center text-xs text-slate-600"><span className="w-3 h-3 rounded bg-emerald-100 border border-emerald-200 mr-1.5"></span>æˆåŠŸ</div>
                                <div className="flex items-center text-xs text-slate-600"><span className="w-3 h-3 rounded bg-yellow-100 border border-yellow-200 mr-1.5"></span>ä¼‘å‡</div>
                            </div>
                        </div>

                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
