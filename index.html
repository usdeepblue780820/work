<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ’ç­ç³»çµ±</title>

<!-- React -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        brand: '#0ea5e9',
        brandDark: '#0284c7',
        brandLight: '#e0f2fe',
        brandBorder: '#bae6fd'
      }
    }
  }
}
</script>

<style>
body {
  font-family: "Noto Sans TC", system-ui, -apple-system;
}
</style>
</head>

<body class="bg-slate-100">
<div id="root"></div>

<script type="text/babel">
const APPS_SCRIPT_URL = "âš ï¸è«‹æ›æˆä½ çš„ Apps Script Web App URL";

const { useState, useEffect, useMemo } = React;

/* ========= ç•«ä¼‘åŸå› è¦–çª— ========= */
function ReasonModal({ open, required, onClose, onSubmit }) {
  const [reason, setReason] = useState("");

  if (!open) return null;

  return (
    <div className="fixed inset-0 bg-black/40 z-50 flex items-center justify-center">
      <div className="bg-white w-80 rounded-xl p-4 shadow-xl">
        <h3 className="font-bold text-lg mb-2 flex items-center gap-2">
          <i className="fa-solid fa-bed text-red-500"></i>
          ç•«ä¼‘åŸå› 
        </h3>

        <textarea
          className="w-full border rounded p-2 text-sm"
          rows="3"
          placeholder={required ? "æ­¤åŸå› ç‚ºå¿…å¡«" : "åŸå› ï¼ˆé¸å¡«ï¼‰"}
          value={reason}
          onChange={e => setReason(e.target.value)}
        />

        {required && !reason && (
          <p className="text-xs text-red-500 mt-1">
            âš ï¸ æœ¬æœˆç¬¬ 5 å¤©èµ·ï¼ŒåŸå› å¿…å¡«
          </p>
        )}

        <div className="flex justify-end gap-2 mt-4">
          <button
            className="px-3 py-1 text-sm bg-gray-200 rounded"
            onClick={onClose}
          >å–æ¶ˆ</button>

          <button
            disabled={required && !reason}
            onClick={() => onSubmit(reason)}
            className="px-3 py-1 text-sm rounded text-white bg-brand disabled:opacity-50"
          >ç¢ºèª</button>
        </div>
      </div>
    </div>
  );
}

/* ========= ä¸»ç¨‹å¼ ========= */
function App() {
  const [months, setMonths] = useState([]);
  const [currentMonth, setCurrentMonth] = useState("");
  const [dates, setDates] = useState([]);
  const [schedule, setSchedule] = useState([]);

  const [filterStore, setFilterStore] = useState("all");
  const [mode, setMode] = useState("view"); // view | edit
  const [currentUser, setCurrentUser] = useState("");

  const [modalOpen, setModalOpen] = useState(false);
  const [modalTarget, setModalTarget] = useState(null);
  const [requireReason, setRequireReason] = useState(false);

  /* å–å¾—æœˆä»½ */
  useEffect(() => {
    fetch(`${APPS_SCRIPT_URL}?action=getMonths`)
      .then(r => r.json())
      .then(d => {
        setMonths(d.months || []);
        setCurrentMonth(d.currentMonth || "");
      });
  }, []);

  /* å–å¾—ç­è¡¨ */
  useEffect(() => {
    if (!currentMonth) return;

    fetch(`${APPS_SCRIPT_URL}?action=getSchedule&sheetName=${currentMonth}`)
      .then(r => r.json())
      .then(d => {
        setDates(d.dates || []);
        setSchedule(d.schedule || []);
        if (d.schedule?.length && !currentUser) {
          setCurrentUser(d.schedule[0].name);
        }
      });
  }, [currentMonth]);

  const filteredSchedule = useMemo(() => {
    return schedule.filter(u =>
      filterStore === "all" || u.store.includes(filterStore)
    );
  }, [schedule, filterStore]);

  /* é»æ ¼å­ */
  function onCellClick(user, date) {
    if (mode !== "edit") return;
    if (!currentUser) return;
    if (user.name !== currentUser) return;

    const restDays =
      Object.values(user.shifts).filter(v => v === "ä¼‘").length;

    setRequireReason(restDays >= 4);
    setModalTarget({ user, date });
    setModalOpen(true);
  }

  /* é€å‡ºç•«ä¼‘ */
  function submitReason(reason) {
    const { user, date } = modalTarget;

    fetch(`${APPS_SCRIPT_URL}?action=updateShift`, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({
        sheetName: currentMonth,
        name: user.name,
        date,
        type: "ä¼‘",
        reason
      })
    })
    .then(r => r.json())
    .then(res => {
      if (res.status === "success") {
        setSchedule(prev =>
          prev.map(u =>
            u.name === user.name
              ? { ...u, shifts: { ...u.shifts, [date]: "ä¼‘" } }
              : u
          )
        );
        setModalOpen(false);
      } else {
        alert(res.message || "æ›´æ–°å¤±æ•—");
      }
    });
  }

  return (
    <div className="flex flex-col h-screen">
      {/* Header */}
      <header className="bg-brand text-white px-4 py-3 flex justify-between items-center shadow">
        <div className="font-bold text-lg flex items-center gap-2">
          <i className="fa-solid fa-calendar-days"></i>
          æ’ç­ç³»çµ±
        </div>

        <div className="flex items-center gap-2">
          <select
            value={currentUser}
            onChange={e => setCurrentUser(e.target.value)}
            className="bg-white text-gray-800 text-sm rounded px-2 py-1"
          >
            {schedule.map(u => (
              <option key={u.name} value={u.name}>
                æˆ‘æ˜¯ï¼š{u.name}
              </option>
            ))}
          </select>

          <button
            onClick={() => setMode("view")}
            className={`px-3 py-1 rounded text-sm border
              ${mode==="view"
                ? "bg-brandLight text-brand border-brandBorder"
                : "bg-white text-gray-500 border-gray-200"
              }`}
          >
            ç€è¦½
          </button>

          <button
            onClick={() => setMode("edit")}
            className={`px-3 py-1 rounded text-sm border
              ${mode==="edit"
                ? "bg-brandLight text-brand border-brandBorder"
                : "bg-white text-gray-500 border-gray-200"
              }`}
          >
            ç•«ä¼‘
          </button>

          <select
            value={currentMonth}
            onChange={e => setCurrentMonth(e.target.value)}
            className="bg-white text-gray-800 text-sm rounded px-2 py-1"
          >
            {months.map(m => (
              <option key={m} value={m}>{m}</option>
            ))}
          </select>
        </div>
      </header>

      {/* åˆ†åº—ç¯©é¸ */}
      <div className="bg-white p-2 border-b flex gap-2">
        {["all","æ¹–å£","æˆåŠŸ"].map(s => (
          <button
            key={s}
            onClick={() => setFilterStore(s)}
            className={`px-3 py-1 rounded text-sm border
              ${filterStore===s
                ? "bg-brandLight text-brand border-brandBorder"
                : "bg-white text-gray-500 border-gray-200"
              }`}
          >
            {s === "all" ? "å…¨éƒ¨åˆ†åº—" : s}
          </button>
        ))}
      </div>

      {/* è¡¨æ ¼ */}
      <div className="flex-1 overflow-auto bg-white">
        <table className="border-collapse min-w-max w-full text-sm">
          <thead className="sticky top-0 bg-slate-50 z-10">
            <tr>
              <th className="sticky left-0 bg-slate-50 border p-2 z-20">å§“å</th>
              {dates.map(d => (
                <th key={d} className="border p-2 text-xs">{d}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {filteredSchedule.map(user => (
              <tr
                key={user.name}
                className={user.name === currentUser ? "bg-brandLight/50" : "opacity-70"}
              >
                <td className="sticky left-0 bg-white border p-2 font-medium z-10">
                  {user.name}
                </td>
                {dates.map(d => (
                  <td
                    key={d}
                    className="border text-center cursor-pointer hover:bg-brandLight"
                    onClick={() => onCellClick(user, d)}
                  >
                    {user.shifts[d] === "ä¼‘" ? "ğŸ›Œ" : ""}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <ReasonModal
        open={modalOpen}
        required={requireReason}
        onClose={() => setModalOpen(false)}
        onSubmit={submitReason}
      />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
