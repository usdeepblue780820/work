<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ’ç­ç³»çµ±</title>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
</head>

<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">
/* ===== è¨­å®šä½ çš„ Apps Script Web App URL ===== */
const APPS_SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbyEwMHBO8jVA0IoS_HdzNFHsyzCz-lxVmW3s9jPcK8gaZDVq1JT5ieeMnQT3V-oNy_U/exec";

const { useState, useEffect } = React;

/* ===== ç•«ä¼‘åŸå› è¦–çª— ===== */
function ReasonModal({ open, onClose, onSubmit, required }) {
  const [reason, setReason] = useState("");

  if (!open) return null;

  return (
    <div className="fixed inset-0 bg-black/40 z-50 flex items-center justify-center">
      <div className="bg-white w-80 rounded-xl p-4 shadow-lg">
        <h3 className="font-bold text-lg mb-2 flex items-center gap-2">
          <i className="fa-solid fa-bed text-red-500"></i>
          ç•«ä¼‘åŸå› 
        </h3>

        <textarea
          className="w-full border rounded p-2 text-sm"
          rows="3"
          placeholder={required ? "æ­¤åŸå› ç‚ºå¿…å¡«" : "åŸå› ï¼ˆé¸å¡«ï¼‰"}
          value={reason}
          onChange={e => setReason(e.target.value)}
        />

        {required && !reason && (
          <p className="text-xs text-red-500 mt-1">
            âš ï¸ æœ¬æœˆç¬¬ 5 å¤©èµ·ï¼ŒåŸå› å¿…å¡«
          </p>
        )}

        <div className="flex justify-end gap-2 mt-4">
          <button
            className="px-3 py-1 text-sm bg-gray-200 rounded"
            onClick={onClose}
          >
            å–æ¶ˆ
          </button>

          <button
            className="px-3 py-1 text-sm bg-orange-500 text-white rounded disabled:opacity-50"
            onClick={() => onSubmit(reason)}
            disabled={required && !reason}
          >
            ç¢ºèª
          </button>
        </div>
      </div>
    </div>
  );
}

/* ===== ä¸»ç¨‹å¼ ===== */
function App() {
  const [months, setMonths] = useState([]);
  const [currentMonth, setCurrentMonth] = useState("");
  const [dates, setDates] = useState([]);
  const [schedule, setSchedule] = useState([]);
  const [currentUser, setCurrentUser] = useState("");

  const [modalOpen, setModalOpen] = useState(false);
  const [modalTarget, setModalTarget] = useState(null);
  const [requireReason, setRequireReason] = useState(false);

  /* ===== å–å¾—æœˆä»½ï¼ˆè‡ªå‹•è·³ç•¶æœˆï¼‰===== */
  useEffect(() => {
    fetch(`${APPS_SCRIPT_URL}?action=getMonths`)
      .then(r => r.json())
      .then(d => {
        setMonths(d.months || []);
        setCurrentMonth(d.currentMonth || "");
      })
      .catch(() => alert("è®€å–æœˆä»½å¤±æ•—"));
  }, []);

  /* ===== å–å¾—ç­è¡¨ ===== */
  useEffect(() => {
    if (!currentMonth) return;

    fetch(`${APPS_SCRIPT_URL}?action=getSchedule&sheetName=${currentMonth}`)
      .then(r => r.json())
      .then(d => {
        setDates(d.dates || []);
        setSchedule(d.schedule || []);
        if (d.schedule?.length && !currentUser) {
          setCurrentUser(d.schedule[0].name);
        }
      })
      .catch(() => alert("è®€å–ç­è¡¨å¤±æ•—"));
  }, [currentMonth]);

  /* ===== é»æ ¼å­ ===== */
  function onCellClick(user, date) {
    if (user.name !== currentUser) return;

    const restDays =
      Object.values(user.shifts).filter(v => v === "ä¼‘").length;

    setRequireReason(restDays >= 4);
    setModalTarget({ user, date });
    setModalOpen(true);
  }

  /* ===== é€å‡ºç•«ä¼‘ï¼ˆä¿®æ³• Aï¼šaction æ”¾ URLï¼‰===== */
  function submitReason(reason) {
    const { user, date } = modalTarget;

    fetch(`${APPS_SCRIPT_URL}?action=updateShift`, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({
        sheetName: currentMonth,
        name: user.name,
        date,
        type: "ä¼‘",
        reason
      })
    })
      .then(r => r.json())
      .then(res => {
        if (res.status === "success") {
          setSchedule(prev =>
            prev.map(u =>
              u.name === user.name
                ? { ...u, shifts: { ...u.shifts, [date]: "ä¼‘" } }
                : u
            )
          );
          setModalOpen(false);
        } else {
          alert(res.message || "æ›´æ–°å¤±æ•—");
        }
      })
      .catch(() => alert("é€£ç·šå¤±æ•—ï¼Œç„¡æ³•å„²å­˜"));
  }

  return (
    <div className="p-4">
      <h1 className="text-xl font-bold mb-3">æ’ç­ç³»çµ±</h1>

      <select
        value={currentMonth}
        onChange={e => setCurrentMonth(e.target.value)}
        className="mb-3 border p-1 rounded"
      >
        {months.map(m => (
          <option key={m} value={m}>{m}</option>
        ))}
      </select>

      <table className="border-collapse w-full bg-white text-sm">
        <thead>
          <tr>
            <th className="border p-2">å§“å</th>
            {dates.map(d => (
              <th key={d} className="border p-1">{d}</th>
            ))}
          </tr>
        </thead>
        <tbody>
          {schedule.map(user => (
            <tr key={user.name}>
              <td className="border p-2 font-medium">{user.name}</td>
              {dates.map(d => (
                <td
                  key={d}
                  className="border text-center cursor-pointer hover:bg-orange-50"
                  onClick={() => onCellClick(user, d)}
                >
                  {user.shifts[d] === "ä¼‘" ? "ğŸ›Œ" : "ï¼‹"}
                </td>
              ))}
            </tr>
          ))}
        </tbody>
      </table>

      <ReasonModal
        open={modalOpen}
        required={requireReason}
        onClose={() => setModalOpen(false)}
        onSubmit={submitReason}
      />
    </div>
  );
}

ReactDOM
  .createRoot(document.getElementById("root"))
  .render(<App />);
</script>
</body>
</html>
